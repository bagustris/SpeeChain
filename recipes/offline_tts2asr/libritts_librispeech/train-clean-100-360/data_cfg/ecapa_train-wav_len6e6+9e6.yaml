### Author: Heli Qi
### Affiliation: NAIST
### Date: 2022.09
# This is a template of data loading configuration on the train-960 dataset of the LibriSpeech corpus
# This configuration fits 4 Ã— Geforce 1080 Ti GPUs with 11GB memory.
# You can modify this configuration according to your computational resource, such as batch_len and ngpu.
# However, you may not be able to reproduce exactly the same performance with different GPU setting.


### --- Reference Zone --- ###
# shared values
valid_set: dev-clean
txt_format: librispeech

# real data-related
real_data_root: datasets/speech_text/librispeech/data/wav
real_train_set: train-clean-100
real_batch_len: 6e6

# pseudo data-related
pseudo_wav_root: recipes/offline_tts2asr/tts_syn_speech/libritts/train-clean-360/default_inference/10_train_loss_average/seed=0_long-filter=0.95_spk-emb=libritts-train-clean-100-ecapa_model=recipes%tts%libritts%train-clean-100%exp%16khz_ecapa_g2p_transformer_v1_accum1_20gb
unspoken_text_root: datasets/speech_text/libritts/data/wav
wav_vocoder: hifigan
pseudo_train_set: train-clean-360
pseudo_batch_len: 9e6
### ------------------------ ###


### --- Training Iterator Configuration --- ###
train:
    real:
        type: block.BlockIterator
        conf:
            dataset_type: speech_text.SpeechTextDataset
            dataset_conf:
                main_data:
                    feat: !ref <real_data_root>/<real_train_set>/idx2wav
                    text: !ref <real_data_root>/<real_train_set>/idx2<txt_format>_text

            data_len: !ref <real_data_root>/<real_train_set>/idx2wav_len
            shuffle: True
            is_descending: True
            batch_len: !ref <real_batch_len>

    pseudo:
        type: block.BlockIterator
        conf:
            dataset_type: speech_text.SpeechTextDataset
            dataset_conf:
                main_data:
                    feat: !ref <pseudo_wav_root>/idx2<wav_vocoder>_wav
                    text: !ref <unspoken_text_root>/<pseudo_train_set>/idx2<txt_format>_text
                data_selection:
                    - min
                    - !str 10
                    - !ref <pseudo_wav_root>/idx2feat_token_len_ratio

            data_len: !ref <pseudo_wav_root>/idx2<wav_vocoder>_wav_len
            shuffle: True
            is_descending: True
            batch_len: !ref <pseudo_batch_len>

### --- Validation Iterator Configuration --- ###
# Although block.BlockIterator can be used here, it may cause a sudden surge of consumed GPU memory.
# By using abs.Iterator, each GPU process load just one data instance at each validation step which reduces the GPU burden.
# However, abs.Iterator may consume more CPU during validation. Please be careful about it.
valid:
    type: abs.Iterator
    conf:
        dataset_type: speech_text.SpeechTextDataset
        dataset_conf:
            main_data:
                feat: !ref <real_data_root>/<valid_set>/idx2wav
                text: !ref <real_data_root>/<valid_set>/idx2<txt_format>_text

        shuffle: False
        data_len: !ref <real_data_root>/<valid_set>/idx2wav_len
